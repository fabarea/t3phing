<?xml version="1.0"?>
<project name="SiteImporter" basedir="Tasks" default="">


	<!--
		==============================================
		Entry Point
		==============================================
	-->
	<target name="initialize" depends="dump, localconf, htaccess, symlink, typo3temp, uploads, user_upload"/>
	<target name="initialize6" depends="dump6, htaccess, symlink, uploads, fileadmin"/>
	<target name="reset" depends="dump6, clear_cache, warmup"/>

	<!--
		==============================================
		Dump database
		==============================================
	-->
	<target name="dump" depends="">
		<echo>-----------------------------</echo>
		<echo>| Dump database |</echo>
		<echo>-----------------------------</echo>

		<echo>Dumping remote database...</echo>

		<dumpRemote
				credentials="${server.credentials}"
				directory="${site.remote.directory.temp}"
				database="${database.remote.name}"
				username="${database.remote.username}"
				password="${database.remote.password}"
				additionalIgnoreTables="tx_realurl_chashcache, tx_realurl_errorlog, tx_realurl_pathcache,
									tx_realurl_redirects, tx_realurl_uniqalias , tx_realurl_urldecodecache, tx_realurl_urlencodecache,
									cache_extensions
									"
				/>

		<echo>Fetching dump...</echo>
		<rsync credentials="${server.credentials}" remoteDirectory="${site.remote.directory.temp}${database.remote.name}.bz2"
		       localDirectory="${site.local.directory}"/>

		<echo>Extracting file...</echo>
		<commandLocal command="tar -C ${site.local.directory} -xjf ${site.local.directory}${database.remote.name}.bz2"/>

		<echo>Reset database...</echo>
		<commandLocal
				command="${mysql.local} -e &quot;DROP DATABASE ${database.local.name}; CREATE DATABASE ${database.local.name};&quot;"/>

		<echo>Import dump...</echo>
		<commandLocal command="${mysql.local} ${database.local.name} &lt; ${site.local.directory}${database.remote.name}.sql"/>

		<echo>Fine tunes database...</echo>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_domain SET domainName = REPLACE(domainName, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_template SET title = REPLACE(title, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_template SET config = REPLACE(config, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_template SET constants = REPLACE(constants, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE pages SET title = REPLACE(title, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>

		<!-- reset database password for admin user -->
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE be_users SET username = 'admin', password = '5f4dcc3b5aa765d61d8327deb882cf99' WHERE username = 'ecoadmin';&quot; ${database.local.name}"/>

		<echo>Clean up environment...</echo>
		<commandLocal command="rm -f ${site.local.directory}${database.remote.name}.bz2"/>
		<commandLocal command="rm -f ${site.local.directory}${database.remote.name}.sql"/>

		<commandRemote credentials="${server.credentials}" command="rm ${site.remote.directory.temp}${database.remote.name}.sql"/>
		<commandRemote credentials="${server.credentials}" command="rm ${site.remote.directory.temp}${database.remote.name}.bz2"/>
	</target>


	<target name="d" depends="dump6"/>
	<target name="dump6" depends="">
		<echo>-----------------------------</echo>
		<echo>| Dump database |</echo>
		<echo>-----------------------------</echo>
		<echo>Dumping remote database...</echo>

		<dumpRemote credentials="${server.credentials}"
		            directory="${site.remote.directory.temp}"
		            database="${database.remote.name}"
		            username="${database.remote.username}"
		            password="${database.remote.password}"
		            additionalIgnoreTables="tx_realurl_chashcache, tx_realurl_errorlog, tx_realurl_pathcache,
									tx_realurl_redirects, tx_realurl_uniqalias , tx_realurl_urldecodecache, tx_realurl_urlencodecache,
									tx_extensionmanager_domain_model_extension
									"
				/>

		<echo>Fetching dump...</echo>
		<rsync credentials="${server.credentials}" remoteDirectory="${site.remote.directory.temp}${database.remote.name}.bz2"
		       localDirectory="${site.local.directory}"/>

		<echo>Extracting file...</echo>
		<commandLocal command="tar -C ${site.local.directory} -xjf ${site.local.directory}${database.remote.name}.bz2"/>

		<echo>Reset database...</echo>
		<commandLocal
				command="${mysql.local} -e &quot;DROP DATABASE ${database.local.name}; CREATE DATABASE ${database.local.name};&quot;"/>

		<echo>Import dump...</echo>
		<commandLocal command="${mysql.local} ${database.local.name} &lt; ${site.local.directory}${database.remote.name}.sql"/>


		<echo>Fine tunes database...</echo>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_domain SET domainName = REPLACE(domainName, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_template SET title = REPLACE(title, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_template SET config = REPLACE(config, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_template SET constants = REPLACE(constants, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE pages SET title = REPLACE(title, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>

		<!-- reset database password for admin user -->
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE be_users SET username = 'admin', password = '5f4dcc3b5aa765d61d8327deb882cf99' WHERE username = 'ecoadmin';&quot; ${database.local.name}"/>

		<echo>Clean up environment...</echo>
		<commandLocal command="rm -f ${site.local.directory}${database.remote.name}.bz2"/>
		<commandLocal command="rm -f ${site.local.directory}${database.remote.name}.sql"/>

		<commandRemote credentials="${server.credentials}" command="rm ${site.remote.directory.temp}${database.remote.name}.sql"/>
		<commandRemote credentials="${server.credentials}" command="rm ${site.remote.directory.temp}${database.remote.name}.bz2"/>


		<echo>Writing local credential...</echo>
		<echo file="configuration/Settings.php" append="false"><![CDATA[<?php

// database credentials
$GLOBALS['TYPO3_CONF_VARS']['DB']['database'] = '${database.local.name}';
$GLOBALS['TYPO3_CONF_VARS']['DB']['password'] = '${database.local.password}';
$GLOBALS['TYPO3_CONF_VARS']['DB']['username'] = '${database.local.username}';
$GLOBALS['TYPO3_CONF_VARS']['DB']['host'] = '${database.local.host}';

// password for all installToolPassword
$GLOBALS['TYPO3_CONF_VARS']['BE']['installToolPassword'] = '5f4dcc3b5aa765d61d8327deb882cf99';
?>]]></echo>

	</target>


	<!--
		==============================================
		Synchronize files
		==============================================
	-->
	<target name="uploads" depends="">
		<echo>-----------------------------</echo>
		<echo>| Fetch uploads|</echo>
		<echo>-----------------------------</echo>
		<echo>fetching files...</echo>
		<rsync credentials="${server.credentials}"
		       remoteDirectory="${site.remote.directory}uploads"
		       localDirectory="${site.local.directory}"/>

	</target>

	<target name="user_upload" depends="">
		<echo>-----------------------------</echo>
		<echo>| Fetch resources files |</echo>
		<echo>-----------------------------</echo>
		<echo>fetching files...</echo>
		<rsync credentials="${server.credentials}"
		       remoteDirectory="${site.remote.directory}fileadmin/user_upload"
		       localDirectory="${site.local.directory}fileadmin"/>
	</target>

	<target name="fileadmin" depends="">
		<echo>-----------------------------</echo>
		<echo>| Fetch fileadmin files |</echo>
		<echo>-----------------------------</echo>
		<echo>fetching files...</echo>
		<rsync credentials="${server.credentials}"
		       remoteDirectory="${site.remote.directory}fileadmin"
		       localDirectory="${site.local.directory}"/>
	</target>

	<!-- ============================================== -->
	<target name="localconf" depends="">
		<echo>-----------------------------</echo>
		<echo>| localconf.php |</echo>
		<echo>-----------------------------</echo>
		<echo>Fetching file...</echo>
		<commandLocal
				command="scp -q ${server.credentials}:${site.remote.directory}typo3conf/localconf.php ${site.local.directory}typo3conf/localconf.php"/>

		<echo>Updating localconf...</echo>
		<localconfFinisher directory="${site.local.directory}"
		                   database="${database.local.name}"
		                   username="${database.local.username}"
		                   password="${database.local.password}"
		                   host="${database.local.host}"/>
	</target>

	<!-- ============================================== -->
	<target name="htaccess" depends="">
		<echo>-----------------------------</echo>
		<echo>| .htaccess |</echo>
		<echo>-----------------------------</echo>
		<echo>Fetching file...</echo>
		<commandLocal command="scp -q ${server.credentials}:${site.remote.directory}.htaccess ${site.local.directory}/"/>
	</target>

	<!-- ============================================== -->
	<target name="symlink" depends="">
		<echo>-----------------------------</echo>
		<echo>| Symlink |</echo>
		<echo>-----------------------------</echo>
		<echo>Creating symlink...</echo>
		<delete file="${site.local.directory}typo3_src"/>
		<symlink target="${path.core}" link="${site.local.directory}typo3_src"/>
	</target>

	<target name="typo3temp" depends="">
		<echo>-----------------------------</echo>
		<echo>| typo3temp |</echo>
		<echo>-----------------------------</echo>
		<echo>Creating typo3temp...</echo>
		<mkdir dir="${site.local.directory}typo3temp"/>
	</target>
</project>