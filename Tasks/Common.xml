<?xml version="1.0"?>
<project name="imported task" basedir="." default=""  description="">

	<property name="mysql.local" value="${command.local.mysql} -u ${database.local.username} -p${database.local.password}"/>

	<!-- FILE SET -->
	<fileset dir="${site.local.directory}typo3temp" id="typo3temp">
		<include name="compressor/**"/>
		<include name="sprites/**"/>
		<include name="*.js"/>
		<include name="*.css"/>
	</fileset>
	<fileset dir="${site.local.directory}typo3conf" id="typo3conf">
		<include name="temp*"/>
		<include name="*.log"/>
	</fileset>
	<path id="t3phing.classes">
		<pathelement dir="${t3phing.home}Classes/"/>
	</path>


	<!-- TASK DEFINITION -->
	<!--<taskdef name="checkRemote" classname="CheckRemote" classpathref="t3phing.classes"/>-->
	<taskdef name="rsync" classname="Rsync" classpathref="t3phing.classes"/>
	<!--<taskdef name="checkLocal" classname="CheckLocal" classpathref="t3phing.classes"/>-->
	<taskdef name="localconfFinisher" classname="LocalconfFinisher" classpathref="t3phing.classes"/>
	<taskdef name="dumpRemote" classname="DumpRemote" classpathref="t3phing.classes"/>
	<taskdef name="commandRemote" classname="CommandRemote" classpathref="t3phing.classes"/>
	<taskdef name="commandLocal" classname="CommandLocal" classpathref="t3phing.classes"/>
	<taskdef name="gitStatusRemote" classname="GitStatusRemote" classpathref="t3phing.classes"/>
	<taskdef name="gitDiffRemote" classname="GitDiffRemote" classpathref="t3phing.classes"/>

	<!--
		==============================================
		Default entry point
		==============================================
	-->
	<target name="help">
		<echo>Usage of this Phing:</echo>
		<echo/>
		<echo>phing dump6           - fetch the database and build it again locally for TYPO3 6.0</echo>
		<echo>phing dump            - fetch the database and build it again locally</echo>
		<echo>phing localconf       - fetch localconf.php and add custom values - OBSOLETE WITH TYPO3 6.0</echo>
		<echo>phing htaccess        - fetch the htaccess from the remote server</echo>
		<echo>phing symlink         - create symlinks to the core - ${path.core}</echo>
		<echo>phing typo3temp       - create typo3temp directory</echo>
		<echo>phing uploads         - fetch uploads folder</echo>
		<echo>phing fileadmin       - fetch fileadmin</echo>
		<echo>phing user_upload     - fetch user_upload folder</echo>
		<echo>phing clean           - delete unnecessary files</echo>
		<echo/>

		<echo>---------------------------------------------</echo>
		<echo>Convenience tasks</echo>
		<echo>---------------------------------------------</echo>
		<echo>phing initialize     - dump, localconf, htaccess, symlink, typo3temp, uploads, user_upload</echo>
		<echo>phing initialize6    - dump6, htaccess, symlink, uploads, fileadmin</echo>
		<!--<echo>phing push           - commit, use -Dmessage="my message"</echo>-->
		<echo>phing test           - test the environment and the remote connection (not yet implemented)</echo>
		<echo>phing help           - display this help message</echo>


		<echo/>
		<echo>---------------------------------------------</echo>
		<echo>Git tasks</echo>
		<echo>---------------------------------------------</echo>
		<echo>phing st             - git remote status</echo>
		<echo>phing df             - git remote diff</echo>

		<echo/>
		<echo>---------------------------------------------</echo>
		<echo>Possible option</echo>
		<echo>---------------------------------------------</echo>
		<echo>-DdryRun=true        - will display the command to be executed</echo>
	</target>


	<!--
		==============================================
		entry point
		==============================================
	-->
	<target name="initialize" depends="dump, localconf, htaccess, symlink, typo3temp, uploads, user_upload"/>
	<target name="initialize6" depends="dump6, htaccess, symlink, uploads, fileadmin"/>

	<!--
		==============================================
		Git Diff Remote
		==============================================
	-->
	<target name="df" depends="diff" />
	<target name="diff" depends="">
		<echo>-----------------------------</echo>
		<echo>| Remote diff                |</echo>
		<echo>-----------------------------</echo>
		<gitDiffRemote directory="${site.remote.directory}" credentials="${server.credentials}"/>
	</target>

	<!--
		==============================================
		Git Remote Status
		==============================================
	-->
	<target name="st" depends="status" />
	<target name="status" depends="">
		<echo>-----------------------------</echo>
		<echo>| Remote status              |</echo>
		<echo>-----------------------------</echo>
		<gitStatusRemote directory="${site.remote.directory}" credentials="${server.credentials}"/>
	</target>

	<!--
		==============================================
		Dump database
		==============================================
	-->
	<target name="dump" depends="">
		<echo>-----------------------------</echo>
		<echo>| Dump database              |</echo>
		<echo>-----------------------------</echo>

		<echo>Dumping remote database...</echo>

		<dumpRemote
			credentials="${server.credentials}"
			directory="${site.remote.directory.temp}"
			database="${database.remote.name}"
			username="${database.remote.username}"
			password="${database.remote.password}"
			additionalIgnoreTables="tx_realurl_chashcache, tx_realurl_errorlog, tx_realurl_pathcache,
									tx_realurl_redirects, tx_realurl_uniqalias , tx_realurl_urldecodecache, tx_realurl_urlencodecache,
									cache_extensions
									"
			/>

		<echo>Fetching dump...</echo>
		<rsync credentials="${server.credentials}" remoteDirectory="${site.remote.directory.temp}${database.remote.name}.bz2" localDirectory="${site.local.directory}"/>

		<echo>Extracting file...</echo>
		<commandLocal command="tar -C ${site.local.directory} -xjf ${site.local.directory}${database.remote.name}.bz2"/>

		<echo>Reset database...</echo>
		<commandLocal
				command="${mysql.local} -e &quot;DROP DATABASE ${database.local.name}; CREATE DATABASE ${database.local.name};&quot;"/>

		<echo>Import dump...</echo>
		<commandLocal command="${mysql.local} ${database.local.name} &lt; ${site.local.directory}${database.remote.name}.sql"/>

		<echo>Fine tunes database...</echo>
		<commandLocal command="${mysql.local} -e &quot;UPDATE sys_domain SET domainName = REPLACE(domainName, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal command="${mysql.local} -e &quot;UPDATE sys_template SET title = REPLACE(title, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal command="${mysql.local} -e &quot;UPDATE sys_template SET config = REPLACE(config, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal command="${mysql.local} -e &quot;UPDATE sys_template SET constants = REPLACE(constants, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal command="${mysql.local} -e &quot;UPDATE pages SET title = REPLACE(title, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>

		<!-- reset database password for admin user -->
		<commandLocal command="${mysql.local} -e &quot;UPDATE be_users SET username = 'admin', password = '5f4dcc3b5aa765d61d8327deb882cf99' WHERE username = 'ecoadmin';&quot; ${database.local.name}"/>

		<echo>Clean up environment...</echo>
		<commandLocal command="rm -f ${site.local.directory}${database.remote.name}.bz2"/>
		<commandLocal command="rm -f ${site.local.directory}${database.remote.name}.sql"/>

		<commandRemote credentials="${server.credentials}" command="rm ${site.remote.directory.temp}${database.remote.name}.sql"/>
		<commandRemote credentials="${server.credentials}" command="rm ${site.remote.directory.temp}${database.remote.name}.bz2"/>
	</target>


	<target name="dump6" depends="">
		<echo>-----------------------------</echo>
		<echo>| Dump database |</echo>
		<echo>-----------------------------</echo>
		<echo>Dumping remote database...</echo>

		<dumpRemote
				credentials="${server.credentials}"
				directory="${site.remote.directory.temp}"
				database="${database.remote.name}"
				username="${database.remote.username}"
				password="${database.remote.password}"
				additionalIgnoreTables="tx_realurl_chashcache, tx_realurl_errorlog, tx_realurl_pathcache,
									tx_realurl_redirects, tx_realurl_uniqalias , tx_realurl_urldecodecache, tx_realurl_urlencodecache,
									tx_extensionmanager_domain_model_extension
									"
				/>

		<echo>Fetching dump...</echo>
		<rsync credentials="${server.credentials}" remoteDirectory="${site.remote.directory.temp}${database.remote.name}.bz2"
		       localDirectory="${site.local.directory}"/>

		<echo>Extracting file...</echo>
		<commandLocal command="tar -C ${site.local.directory} -xjf ${site.local.directory}${database.remote.name}.bz2"/>

		<echo>Reset database...</echo>
		<commandLocal
				command="${mysql.local} -e &quot;DROP DATABASE ${database.local.name}; CREATE DATABASE ${database.local.name};&quot;"/>

		<echo>Import dump...</echo>
		<commandLocal command="${mysql.local} ${database.local.name} &lt; ${site.local.directory}${database.remote.name}.sql"/>


		<echo>Fine tunes database...</echo>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_domain SET domainName = REPLACE(domainName, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_template SET title = REPLACE(title, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_template SET config = REPLACE(config, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE sys_template SET constants = REPLACE(constants, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE pages SET title = REPLACE(title, '${domain.remote}', '${domain.local}');&quot; ${database.local.name}"/>

		<!-- reset database password for admin user -->
		<commandLocal
				command="${mysql.local} -e &quot;UPDATE be_users SET username = 'admin', password = '5f4dcc3b5aa765d61d8327deb882cf99' WHERE username = 'ecoadmin';&quot; ${database.local.name}"/>

		<echo>Clean up environment...</echo>
		<commandLocal command="rm -f ${site.local.directory}${database.remote.name}.bz2"/>
		<commandLocal command="rm -f ${site.local.directory}${database.remote.name}.sql"/>

		<commandRemote credentials="${server.credentials}" command="rm ${site.remote.directory.temp}${database.remote.name}.sql"/>
		<commandRemote credentials="${server.credentials}" command="rm ${site.remote.directory.temp}${database.remote.name}.bz2"/>


		<echo>Writing local credential...</echo>
		<echo file="configuration/Settings.php" append="false"><![CDATA[<?php

// database credentials
$GLOBALS['TYPO3_CONF_VARS']['DB']['database'] = '${database.local.name}';
$GLOBALS['TYPO3_CONF_VARS']['DB']['password'] = '${database.local.password}';
$GLOBALS['TYPO3_CONF_VARS']['DB']['username'] = '${database.local.username}';
$GLOBALS['TYPO3_CONF_VARS']['DB']['host'] = '${database.local.host}';

// password for all installToolPassword
$GLOBALS['TYPO3_CONF_VARS']['BE']['installToolPassword'] = '5f4dcc3b5aa765d61d8327deb882cf99';
?>]]></echo>

	</target>

	<!--
		==============================================
		Synchronize source code
		==============================================
	-->
	<target name="clean" depends="">
		<echo>-----------------------------</echo>
		<echo>| Clean up                  |</echo>
		<echo>-----------------------------</echo>
		<echo>Deleting temporary files...</echo>
		<delete>
			<fileset refid="typo3temp"/>
			<fileset refid="typo3conf"/>
		</delete>
	</target>

	<!--
		==============================================
		Synchronize files
		==============================================
	-->
	<target name="uploads" depends="">
		<echo>-----------------------------</echo>
		<echo>| Fetch uploads|</echo>
		<echo>-----------------------------</echo>
		<echo>fetching files...</echo>
		<rsync
				credentials="${server.credentials}"
				remoteDirectory="${site.remote.directory}uploads"
				localDirectory="${site.local.directory}"/>

	</target>

	<target name="user_upload" depends="">
		<echo>-----------------------------</echo>
		<echo>| Fetch resources files      |</echo>
		<echo>-----------------------------</echo>
		<echo>fetching files...</echo>
		<rsync
				credentials="${server.credentials}"
				remoteDirectory="${site.remote.directory}fileadmin/user_upload"
				localDirectory="${site.local.directory}fileadmin"/>
	</target>

	<target name="fileadmin" depends="">
		<echo>-----------------------------</echo>
		<echo>| Fetch fileadmin files      |</echo>
		<echo>-----------------------------</echo>
		<echo>fetching files...</echo>
		<rsync
				credentials="${server.credentials}"
				remoteDirectory="${site.remote.directory}fileadmin"
				localDirectory="${site.local.directory}"/>
	</target>

	<!-- ============================================== -->
	<target name="localconf" depends="">
		<echo>-----------------------------</echo>
		<echo>| localconf.php              |</echo>
		<echo>-----------------------------</echo>
		<echo>Fetching file...</echo>
		<commandLocal command="scp -q ${server.credentials}:${site.remote.directory}typo3conf/localconf.php ${site.local.directory}typo3conf/localconf.php"/>

		<echo>Updating localconf...</echo>
		<localconfFinisher
			directory="${site.local.directory}"
			database="${database.local.name}"
			username="${database.local.username}"
			password="${database.local.password}"
			host="${database.local.host}"/>
	</target>

	<!-- ============================================== -->
	<target name="htaccess" depends="">
		<echo>-----------------------------</echo>
		<echo>| .htaccess                  |</echo>
		<echo>-----------------------------</echo>
		<echo>Fetching file...</echo>
		<commandLocal command="scp -q ${server.credentials}:${site.remote.directory}.htaccess ${site.local.directory}/"/>
	</target>

	<!-- ============================================== -->
	<target name="symlink" depends="">
		<echo>-----------------------------</echo>
		<echo>| Symlink                   |</echo>
		<echo>-----------------------------</echo>
		<echo>Creating symlink...</echo>
		<delete	file="${site.local.directory}typo3_src"/>
		<symlink target="${path.core}" link="${site.local.directory}typo3_src" />
	</target>

	<target name="typo3temp" depends="">
		<echo>-----------------------------</echo>
		<echo>| typo3temp                   |</echo>
		<echo>-----------------------------</echo>
		<echo>Creating typo3temp...</echo>
		<mkdir dir="${site.local.directory}typo3temp" />
	</target>

	<!--
		==============================================
		Test the environment
		==============================================
	-->
	<target name="test" depends="">
		<echo>-----------------------------</echo>
		<echo>| Test environment           |</echo>
		<echo>-----------------------------</echo>
		<echo>Not yet implemented</echo>
	</target>

</project>